<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¨×•×× ×”×¢×ª×™×§×” - ×”×§×•×œ×•×¡×™××•×</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #ui-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 100;
        }

        #hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(20, 15, 10, 0.9) 0%, rgba(40, 30, 15, 0.9) 100%);
            padding: 25px;
            border: 2px solid #d4af37;
            border-radius: 12px;
            min-width: 300px;
            pointer-events: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8), 0 0 20px rgba(212, 175, 55, 0.2);
            backdrop-filter: blur(12px);
            border-image: linear-gradient(to bottom, #d4af37, #8b6914) 1;
        }

        #hud h3 {
            color: #d4af37;
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.8);
        }

        #mission-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.95) 0%, rgba(80, 0, 0, 0.95) 100%);
            padding: 25px;
            border: 3px solid #ff4444;
            border-radius: 15px;
            min-width: 350px;
            max-width: 450px;
            pointer-events: auto;
            box-shadow: 0 0 40px rgba(255, 68, 68, 0.6), inset 0 0 20px rgba(255, 68, 68, 0.1);
            backdrop-filter: blur(10px);
        }

        #mission-panel h3 {
            color: #ffaa00;
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-shadow: 0 0 10px rgba(255, 170, 0, 0.8);
        }

        #mission-text {
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        /* ××¤×” */
        #minimap-container {
            position: absolute;
            bottom: 25px;
            right: 25px;
            width: 320px;
            height: 400px;
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid #d4af37;
            border-radius: 16px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.9);
        }

        #minimap-log {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 0.9rem;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(20, 15, 10, 0.5);
        }

        #minimap-log h4 {
            color: #d4af37;
            margin-bottom: 8px;
            font-size: 1rem;
            text-decoration: underline;
        }

        .discovery-entry {
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ddd;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        #minimap {
            width: 100%;
            height: 200px; /* Adjusted height for the canvas */
            position: relative;
            background: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%);
        }

        #minimap canvas {
            width: 100%;
            height: 100%;
            display: block; /* Important for canvas sizing */
        }

        .map-legend {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.7rem;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 320px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.98) 0%, rgba(30, 20, 10, 0.98) 100%);
            padding: 30px;
            border: 4px solid #d4af37;
            border-radius: 20px;
            max-width: 800px;
            display: none;
            pointer-events: auto;
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.7), inset 0 0 30px rgba(212, 175, 55, 0.1);
            backdrop-filter: blur(15px);
        }

        #info-panel h2 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 2rem;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
        }

        #info-panel p {
            line-height: 2.2;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        #close-info {
            margin-top: 20px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #d4af37 0%, #8b6914 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: 0.3s;
        }

        #close-info:hover {
            background: linear-gradient(135deg, #f4cf47 0%, #d4af37 100%);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
        }

        #main-menu {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 30%, #0f3460 60%, #1a1a2e 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #main-menu::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        #main-menu h1 {
            font-size: 5rem;
            color: #d4af37;
            text-shadow: 0 0 40px rgba(212, 175, 55, 1), 0 0 80px rgba(212, 175, 55, 0.6);
            margin-bottom: 30px;
            animation: glow 2s ease-in-out infinite alternate;
            position: relative;
            z-index: 1;
        }

        @keyframes glow {
            from { 
                text-shadow: 0 0 40px rgba(212, 175, 55, 1), 0 0 80px rgba(212, 175, 55, 0.6);
                transform: scale(1);
            }
            to { 
                text-shadow: 0 0 60px rgba(212, 175, 55, 1), 0 0 120px rgba(212, 175, 55, 0.8), 0 0 180px rgba(212, 175, 55, 0.4);
                transform: scale(1.02);
            }
        }

        #main-menu p {
            font-size: 1.5rem;
            margin-bottom: 50px;
            color: #fff;
            max-width: 800px;
            line-height: 2;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 1;
        }

        .start-btn {
            padding: 25px 70px;
            font-size: 1.8rem;
            border: 4px solid #d4af37;
            background: transparent;
            color: #d4af37;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
            position: relative;
            z-index: 1;
        }

        .start-btn:hover {
            background: #d4af37;
            color: #000;
            box-shadow: 0 0 60px rgba(212, 175, 55, 1);
            transform: scale(1.15);
        }

        /* ×ª××™×›×” ×‘×©×œ×˜ */
        #gamepad-indicator {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 200, 0, 0.9);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            display: none;
            z-index: 1;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }

        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 15, 5, 0.95) 100%);
            padding: 20px;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 2;
            pointer-events: auto;
            border: 2px solid #555;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        #instructions h4 {
            color: #d4af37;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .key-badge {
            background: linear-gradient(135deg, #333 0%, #222 100%);
            padding: 4px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-weight: bold;
            border: 1px solid #555;
            min-width: 40px;
            text-align: center;
        }

        .gamepad-badge {
            background: linear-gradient(135deg, #1a5f1a 0%, #0d3d0d 100%);
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            border: 1px solid #2a8f2a;
        }

        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 28px;
            height: 28px;
            border: 3px solid rgba(212, 175, 55, 1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.8);
            z-index: 200;
        }

        #crosshair::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 3px;
            height: 12px;
            background: rgba(212, 175, 55, 1);
            transform: translate(-50%, -50%);
        }

        #crosshair::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 3px;
            background: rgba(212, 175, 55, 1);
            transform: translate(-50%, -50%);
        }

        #npc-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            border: 4px solid #00ff00;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.8);
            animation: npcPulse 1.5s ease-in-out infinite;
            z-index: 199;
        }

        @keyframes npcPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
        }

        #npc-indicator::before {
            content: 'ğŸ‘¤';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
        }

        #npc-name-indicator {
            position: fixed;
            top: calc(50% + 60px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 20px;
            border: 2px solid #00ff00;
            border-radius: 8px;
            color: #00ff00;
            font-weight: bold;
            pointer-events: none;
            display: none;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
            z-index: 199;
        }

        #view-mode {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #d4af37;
            border-radius: 8px;
            color: #d4af37;
            font-weight: bold;
            pointer-events: auto;
            display: none;
        }

        #story-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.98) 0%, rgba(20, 10, 5, 0.98) 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 50px;
        }

        #story-overlay h2 {
            font-size: 3rem;
            color: #d4af37;
            margin-bottom: 40px;
            text-shadow: 0 0 30px rgba(212, 175, 55, 1);
        }

        #story-overlay p {
            font-size: 1.5rem;
            line-height: 2.5;
            max-width: 1000px;
            margin-bottom: 40px;
        }

        #continue-btn {
            padding: 20px 50px;
            font-size: 1.4rem;
            background: linear-gradient(135deg, #d4af37 0%, #8b6914 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        #continue-btn:hover {
            background: linear-gradient(135deg, #f4cf47 0%, #d4af37 100%);
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
        }

        #audio-control {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 15, 5, 0.9) 100%);
            border: 2px solid #d4af37;
            border-radius: 8px;
            color: #d4af37;
            cursor: pointer;
            pointer-events: auto;
            font-weight: bold;
            transition: 0.3s;
        }

        #audio-control:hover {
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        #dialogue-box {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.98) 0%, rgba(30, 20, 10, 0.98) 100%);
            padding: 30px;
            border: 3px solid #d4af37;
            border-radius: 15px;
            max-width: 800px;
            display: none;
            pointer-events: auto;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.7), inset 0 0 20px rgba(212, 175, 55, 0.1);
            backdrop-filter: blur(15px);
        }

        #dialogue-box h3 {
            color: #d4af37;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        #dialogue-box p {
            font-size: 1.2rem;
            line-height: 2;
            margin-bottom: 20px;
        }

        .dialogue-option {
            padding: 12px 20px;
            margin: 8px 0;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(139, 105, 20, 0.2) 100%);
            border: 2px solid #d4af37;
            color: #fff;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.3s;
            text-align: right;
            width: 100%;
        }

        .dialogue-option:hover {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.5) 0%, rgba(139, 105, 20, 0.5) 100%);
            transform: translateX(-10px);
        }

        /* Discovery notification */
        #discovery-notification {
            position: fixed;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(0, 100, 0, 0.95) 0%, rgba(0, 60, 0, 0.95) 100%);
            padding: 20px 40px;
            border: 3px solid #00ff00;
            border-radius: 15px;
            color: #fff;
            font-size: 1.3rem;
            display: none;
            z-index: 300;
            animation: slideDown 0.5s ease-out;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.6);
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-50px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* ×§×•× ×¡×•×œ×ª ×¤×§×•×“×•×ª */
        #game-console {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 10000;
            align-items: center;
            padding: 0 20px;
            border-bottom: 2px solid #00ff00;
            direction: ltr; /* ×¤×§×•×“×•×ª ×‘×× ×’×œ×™×ª */
        }

        #console-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            outline: none;
            margin-left: 10px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #aaa;
            color: #fff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }
        .close-btn:hover { background: #ff4444; border-color: #ff4444; }
    </style>
</head>
<body>
    <div id="main-menu">
        <h1>ğŸ° ×¨×•×× ×‘×™××™ ×”×‘×™× ×™×™×</h1>
        <p>×©× ×ª 1140 ×œ×¡×¤×™×¨×”. ××ª×” ×’'×¨××¨×“, ××‘×™×¨ ×‘××¡×“×¨ ××‘×™×¨×™ ×”×™×›×œ ×©×œ××”, ×©× ×©×œ×— ×œ×¨×•×× ×‘××©×™××” ×—×©××™×ª. ×©×¨×™×“ ×§×“×•×© ××‘×“, ×•×”×©××•×¢×•×ª ××•××¨×•×ª ×©×”×•× ×”×•×¡×ª×¨ ×‘×¢×™×¨ ×”× ×¦×— ×”××ª×¤×•×¨×¨×ª. ×‘×™×©×•×£ ××•×©×—×ª ×¨×•×“×£ ××—×¨ ×”×©×¨×™×“ ×›×“×™ ×œ×”×©×ª××© ×‘×›×•×—×• ×œ×¨×¢×”. ×¢×œ×™×š ×œ××¦×•× ××•×ª×• ×¨××©×•×Ÿ. ×—×§×•×¨ ××ª ×—×•×¨×‘×•×ª ×¨×•××, ×©×•×—×— ×¢× ×ª×•×©×‘×™×” - ×¦×œ×™×™× ×™×, ×¡×•×—×¨×™× ×•× ×–×™×¨×™× - ×•×—×©×•×£ ××ª ×¡×•×“×•×ª ×”×¢×‘×¨ ×›×“×™ ×œ×”×¦×™×œ ××ª ×¢×ª×™×“ ×”××¡×“×¨.</p>
        <button class="start-btn" onclick="startGame()">×”×ª×—×œ ××ª ×”××¡×¢</button>
        <div id="gamepad-indicator">ğŸ® ×©×œ×˜ ×–×•×”×”! ××ª×” ×™×›×•×œ ×œ×©×—×§ ×¢× ×”×’'×•×™×¡×˜×™×§</div>
    </div>

    <div id="story-overlay">
        <h2 id="story-title">×”××©×™××”</h2>
        <p id="story-text"></p>
        <button id="continue-btn" onclick="continueStory()">×”××©×š</button>
    </div>

    <div id="ui-layer">
        <div id="hud">
            <h3>ğŸ“œ ××™×“×¢ ×”×™×¡×˜×•×¨×™</h3>
            <div id="location-name">××™×§×•×: ×©×¢×¨ ×”×¢×™×¨</div>
            <div id="year">×©× ×”: 1140 ×œ×¡×¤×™×¨×”</div>
            <div id="discoveries" style="margin-top: 15px;">
                <div>×’×™×œ×•×™×™×: <span id="discovery-count">0</span>/8</div>
                <div style="margin-top: 10px;">××©×™××•×ª: <span id="quest-count">0</span>/5</div>
                <div style="margin-top: 10px; color: #ffaa00;">NPCs × ×¤×’×©×•: <span id="npc-count">0</span>/6</div>
            </div>
        </div>

        <div id="mission-panel">
            <button class="close-btn" onclick="toggleMissionPanel()">X</button>
            <h3>âš”ï¸ ×”××©×™××”</h3>
            <div id="mission-text">ğŸ¯ ×”××©×™××” ×©×œ×š: ××¦× 5 ×¤×¨×™×˜×™× ×—×©×•×‘×™×, ×¤×ª×•×¨ 3 ×—×™×“×•×ª, ×©×•×—×— ×¢× 6 ×ª×•×©×‘×™×, ×•×’×œ×” 8 ××§×•××•×ª ×”×™×¡×˜×•×¨×™×™×. ×”×ª×—×œ ××”×§×•×œ×•×¡×™××•× ×‘××¨×›×– ×”×¢×™×¨!</div>
        </div>

        <div id="view-mode">ğŸ” ××¦×‘ ×ª×¦×¤×™×ª - ×œ×—×¥ V ×œ×—×–×•×¨</div>

        <!-- ××¤×” ×—×“×©×” -->
        <div id="minimap-container">
            <button class="close-btn" onclick="toggleMinimap()">X</button>
            <div id="minimap-header">ğŸ›ï¸ ××¤×ª ×™××™ ×”×‘× ×™×™× ×•×™×•××Ÿ ×’×™×œ×•×™×™×</div>
            <div id="minimap" style="height: 200px;">
                <canvas id="minimap-canvas"></canvas>
            </div>
            <div id="minimap-log">
                <h4>ğŸ“œ ×’×™×œ×•×™×™× ××—×¨×•× ×™×:</h4>
                <div id="log-entries">
                    <div class="discovery-entry">×”××¡×¢ ××ª×—×™×œ...</div>
                </div>
            </div>
        </div>

        <div id="info-panel">
            <h2 id="info-title">×›×•×ª×¨×ª</h2>
            <p id="info-text">×ª×•×›×Ÿ ××™×“×¢...</p>
            <button id="close-info" onclick="closeInfo()">×¡×’×•×¨</button>
        </div>

        <div id="dialogue-box">
            <h3 id="dialogue-name">×“××•×ª</h3>
            <p id="dialogue-text">×˜×§×¡×˜...</p>
            <div id="dialogue-options"></div>
        </div>

        <div id="instructions">
            <h4>ğŸ® ×¤×§×•×“×•×ª:</h4>
            <div class="control-row">
                <span class="key-badge">WASD</span> / <span class="gamepad-badge">ğŸ•¹ï¸ ×’'×•×™×¡×˜×™×§ ×©×××œ×™</span> - ×ª× ×•×¢×”
            </div>
            <div class="control-row">
                <span class="key-badge">×¢×›×‘×¨</span> / <span class="gamepad-badge">ğŸ•¹ï¸ ×’'×•×™×¡×˜×™×§ ×™×× ×™</span> - ×”×¡×ª×›×œ×•×ª
            </div>
            <div class="control-row">
                <span class="key-badge">E</span> / <span class="gamepad-badge">A / X</span> - ××™× ×˜×¨××§×¦×™×”
            </div>
            <div class="control-row">
                <span class="key-badge">V</span> / <span class="gamepad-badge">Y</span> - ××¦×‘ ×ª×¦×¤×™×ª
            </div>
            <div class="control-row">
                <span class="key-badge">M</span> / <span class="gamepad-badge">Back</span> - ×”×¦×’/×”×¡×ª×¨ ××¤×”
            </div>
                <div class="control-row">
                <span class="key-badge">h</span> / <span class="gamepad-badge">××™×Ÿ</span> -××¡×š ××œ× ×•××¡×š ×œ× ××œ×
            </div>
        </div>

        <button id="audio-control" style="display: none;" onclick="toggleAudio()">ğŸ”Š ××•×–×™×§×”: ×¤×¢×™×œ</button>
    </div>

    <div id="discovery-notification"></div>
    <div id="crosshair"></div>
    <div id="npc-indicator"></div>
    <div id="npc-name-indicator"></div>

    <div id="game-console">
        <span style="color: #00ff00; font-weight: bold; font-size: 1.5rem;">></span>
        <input type="text" id="console-input" placeholder="Enter command (zviki...)" autocomplete="off">
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let scene, camera, renderer, controls, clock, composer;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        const discoveries = new Set();
        const quests = new Set();
        const npcsMet = new Set();
        const interactiveObjects = [];
        const collisionObjects = [];
        let gameStarted = false;
        let viewMode = false;
        let audioContext, backgroundMusic, isAudioPlaying = true;
        let currentStory = 0;
        const playerRadius = 1.5;
        const playerHeight = 5;

        let cameraRotationX = 0; // ××¢×œ×”/××˜×”
        let cameraRotationY = 0; // ×™××™×Ÿ/×©×××œ
        let gamepadIndex = null;
        let gamepadConnected = false;
        let lastGamepadButtons = {};
        let canJump = false;
        let teleportLocations = [];
        
        const puzzles = new Map();
        let activePuzzle = null;
        
        let isConsoleOpen = false;
        let isUIHidden = false;

        // Minimap
        let minimapCanvas, minimapCtx;
        let mapDiscoveries = [];
        let showMinimap = true;
        let showMissionPanel = true;

        // ×”×’×“×¨×ª ×’×©×¨×™×
        const bridges = [
            { x: 0, width: 40 },      // ×’×©×¨ ××¨×›×–×™ (××•×œ ×”×§×•×œ×•×¡×™××•×)
            { x: -200, width: 30 },   // ×’×©×¨ ××¢×¨×‘×™ (×œ×™×“ ×”×¤×•×¨×•×)
            { x: 200, width: 30 }     // ×’×©×¨ ××–×¨×—×™
        ];
        
        // ××™×§×•××™ ××•×‘×™×™×§×˜×™× ×‘××¤×”
        const mapObjects = {
            npcs: [],
            quests: [],
            discoveries: [],
            buildings: []
        };

        // ×¡×™×¤×•×¨ ×”××©×—×§
        const story = [
            {
                title: "××¡×“×¨ ××‘×™×¨×™ ×”×™×›×œ ×©×œ××”",
                text: "××ª×” ×’'×¨××¨×“, ××‘×™×¨ ×‘××¡×“×¨. ×”×©×¨×™×“ ×”×§×“×•×© × ×’× ×‘ ×•×”×•×¡×ª×¨ ×‘×—×•×¨×‘×•×ª ×¨×•××. ×”×‘×™×©×•×£ ×”××•×©×—×ª ×¨×•×“×£ ××—×¨×™×• ×›×“×™ ×œ×¦×‘×•×¨ ×›×•×—. ×¢×œ×™×š ×œ××¦×•× ××ª ×”×©×¨×™×“ ×œ×¤× ×™×•. ×—×¦×” ××ª ×”×¢×™×¨ ×”×¢×ª×™×§×”, ××¦× 8 ×¨××–×™×, ×©×•×—×— ×¢× ×”×ª×•×©×‘×™×, ×•×¦×‘×•×¨ 5 ×¤×¨×™×˜×™× ×›×“×™ ×œ×¤×ª×•×— ××ª ×”×ª×™×‘×” ×”×§×“×•×©×”."
            },
            {
                title: "×¨×•×× ×©×œ ×™××™ ×”×‘×™× ×™×™×",
                text: "××ª×” ×¢×•××“ ×‘×©×¢×¨ ×”×¢×™×¨. ×¨×•××, ×©×”×™×ª×” ×¤×¢× ××™××¤×¨×™×” ××“×™×¨×”, ×”×™× ×›×¢×ª ×¢×™×¨ ×©×œ ×—×•×¨×‘×•×ª ×•××‘×¦×¨×™×. ××©×¤×—×•×ª ××¦×•×œ×” × ×œ×—××•×ª ×¢×œ ×©×œ×™×˜×”, ×•×”×§×•×œ×•×¡×™××•× ×”×¤×š ×œ××‘×¦×¨. ×”×¢×™×¨ ××œ××” ×‘×¦×œ×™×™× ×™×, ×¡×•×—×¨×™× ×•× ×–×™×¨×™×. ×›×œ ××—×“ ××”× ×™×›×•×œ ×œ×”×—×–×™×§ ×¨××–."
            },
            {
                title: "×”×—×™×¤×•×© ××ª×—×™×œ",
                text: "×”×¢×™×¨ ×¤×¨×•×©×” ×œ×¤× ×™×š. ×‘×™×Ÿ ×”×›× ×¡×™×•×ª ×•×”×©×•×•×§×™× ××¡×ª×ª×¨×™× ×¡×•×“×•×ª ×¢×ª×™×§×™×. ×”×ª×—×œ ×œ×—×§×•×¨ - ×’×œ×” ××ª ×”×××ª, ××¡×•×£ ××™×“×¢, ×•×”×™×–×”×¨ ×××•×™×‘×™×. ×‘×“×•×§ ××ª ×”××¤×” ×›×“×™ ×œ×¨××•×ª ××” ×’×™×œ×™×ª!"
            }
        ];

        // NPCs - ××™×§×•××™× ××©×•×¤×¨×™× ×›×“×™ ×©×™×”×™×• ×™×•×ª×¨ × ×’×™×©×™×
        const npcs = {
            merchant: {
                name: "×”×¡×•×—×¨ ××“×’×¨",
                position: [50, 0, 40], // ×§×¨×•×‘ ×™×•×ª×¨ ×œ××¨×›×–
                dialogue: {
                    text: "×‘×¨×•×š ×”×‘×! ×× ×™ ××“×’×¨, ×¡×•×—×¨ ×‘×©××™× ×•×‘×“×™×. ×©××¢×ª×™ ×©××ª×” ××—×¤×© ××©×”×• ×™×§×¨ ×¢×¨×š...",
                    options: [
                        { text: "××” ××ª×” ×™×•×“×¢ ×¢×œ ×”×©×¨×™×“ ×”×§×“×•×©?", response: "×©××¢×ª×™ ×©×”×‘×™×©×•×£ ××—×¤×© ××•×ª×• ×’×... ×–×” ××¡×•×›×Ÿ ×××•×“. ×”×•× ×¨×•×¦×” ×œ×©×œ×•×˜ ×‘×¢×™×¨!", quest: null },
                        { text: "××™×¤×” ×”×§×•×œ×•×¡×™××•×?", response: "×”××‘×¦×¨ ×©×œ ××©×¤×—×ª ×¤×¨× ×’'×™×¤× ×™? ×”×•× ×‘××¨×›×–, ××‘×œ ×”×™×–×”×¨, ×–×” ××§×•× ××¡×•×›×Ÿ.", quest: null },
                        { text: "×™×© ×œ×š ×¨××–×™×?", response: "×©××¢×ª×™ ×©×”× ×–×™×¨ ×”×™×œ×“×‘×¨× ×“ ×™×•×“×¢ ××©×”×•... ×”×•× × ××¦× ×‘×¦×“ ×”××–×¨×—×™ ×©×œ ×”×¢×™×¨.", quest: null },
                        { text: "×ª×•×“×”", response: "×‘×”×¦×œ×—×” ×‘××©×™××” ×©×œ×š! ×”×™×–×”×¨ ××”×‘×™×©×•×£!", quest: null }
                    ]
                },
                info: "merchant"
            },
            guard: {
                name: "×”×©×•××¨ ×¨×•×‘×¨×˜",
                position: [60, 0, -30], // ×§×¨×•×‘ ×™×•×ª×¨ ×œ××¨×›×–
                dialogue: {
                    text: "×¢×¦×•×¨! ××™ ××ª×”? ×× ×™ ×©×•××¨ ×¢×œ ×”×›× ×™×¡×” ×œ××‘×¦×¨.",
                    options: [
                        { text: "×× ×™ ×’'×¨××¨×“, ××‘×™×¨ ×”××¡×“×¨", response: "××”, ××‘×™×¨! ×›×‘×•×“ ×”×•× ×œ×™. ×”×™×›× ×¡, ××š ×¤×§×— ×¢×™× ×™×™×. ×”× ×” ××¤×ª×— ×©×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š.", quest: "quest1" },
                        { text: "×× ×™ ××—×¤×© ××ª ×”×©×¨×™×“ ×”××‘×•×“", response: "×–×” ××¡×•×›×Ÿ... ×©××¢×ª×™ ×©×”×©×¨×™×“ ×‘×§×•×œ×•×¡×™××•×, ××ª×—×ª ×œ××“××”. ×”× ×” ××¤×ª×—.", quest: "quest1" },
                        { text: "××” ×”××¦×‘ ×‘×¢×™×¨?", response: "×›××•×¡. ×”××¦×™×œ×™× × ×œ×—××™× ×¢×œ ×©×œ×™×˜×”.", quest: null }
                    ]
                },
                info: "guard"
            },
            priest: {
                name: "×”××‘ ×× ×¡×’×¨",
                position: [-50, 0, 50], // ×§×¨×•×‘ ×™×•×ª×¨ ×œ××¨×›×–
                dialogue: {
                    text: "×©×œ×•× ×‘× ×™. ×‘××ª ×œ×”×ª×¤×œ×œ ×‘×›× ×¡×™×™×”?",
                    options: [
                        { text: "××” ××ª×” ×™×•×“×¢ ×¢×œ ×”×©×¨×™×“?", response: "×”×•× ×”×™×” ×©×™×™×š ×œ×§×“×•×© ×¤×˜×¨×•×¡. ×”×•× ×”×•×—×‘× ×›×©×”×‘×¨×‘×¨×™× ×¤×œ×©×•.", quest: null },
                        { text: "××™×¤×” ×”×›× ×¡×™×™×”?", response: "×–×•×”×™ ×›× ×¡×™×™×ª ×¡× ×˜×” ××¨×™×”, ×©× ×‘× ×ª×” ×¢×œ ××§×“×© ×¢×ª×™×§.", quest: null },
                        { text: "×ª×•×“×”", response: "×œ×š ×‘×“×¨×›×™ ×”××œ.", quest: null }
                    ]
                },
                info: "priest"
            },
            gladiator: {
                name: "×”××‘×™×¨ ×¨×™×¦'×¨×“",
                position: [20, 0, 20], // ×œ×™×“ ×”×§×•×œ×•×¡×™××•× ××‘×œ ×œ× ×‘×“×™×•×§ ×‘××¨×›×–
                dialogue: {
                    text: "×©×œ×•×, ××— ×œ× ×©×§. ××” ××‘×™× ××•×ª×š ×œ×—×•×¨×‘×•×ª ××œ×•?",
                    options: [
                        { text: "×× ×™ ××—×¤×© ××ª ×”×©×¨×™×“ ×”××‘×•×“", response: "×’× ×× ×™. ×©××¢×ª×™ ×©×”×•× × ××¦× ×‘××¨×›×– ×”×–×™×¨×”, ××ª×—×ª ×œ××“××”.", quest: "quest2" },
                        { text: "××” ××ª×” ×™×•×“×¢ ×¢×œ ×”××§×•× ×”×–×”?", response: "×¤×¢× × ×œ×—××• ×¤×” ×’×œ×“×™××˜×•×¨×™×. ×”×™×•× ×–×” ×‘×™×ª ×§×‘×¨×•×ª ×•××‘×¦×¨.", quest: null }
                    ]
                },
                info: "knight"
            },
            citizen: {
                name: "×”××™×›×¨×” ××˜×™×œ×“×”",
                position: [-40, 0, -40], // ×§×¨×•×‘ ×™×•×ª×¨ ×œ××¨×›×–
                dialogue: {
                    text: "×× ×, ××“×•× ×™ ×”××‘×™×¨, ×™×© ×œ×š ××˜×‘×¢?",
                    options: [
                        { text: "×× ×™ ××—×¤×© ×¨××–×™×", response: "×¨××™×ª×™ × ×–×™×¨×™× ××¡×ª×™×¨×™× ××©×”×• ×‘×©×•×§ ×”×™×©×Ÿ (×”×¤×•×¨×•×).", quest: "quest3" },
                        { text: "××™×¤×” ×”×©×•×§?", response: "×©×, ××™×¤×” ×©×”×¢××•×“×™× ×”×©×‘×•×¨×™×.", quest: null },
                        { text: "×§×—×™ ××˜×‘×¢", response: "×ª×•×“×”! ×ª×•×“×”! ××œ×•×”×™× ×™×‘×¨×š ××•×ª×š.", quest: null }
                    ]
                },
                info: "peasant"
            },
            scholar: {
                name: "×”× ×–×™×¨ ×”×™×œ×“×‘×¨× ×“",
                position: [80, 0, 60], // ×§×¨×•×‘ ×™×•×ª×¨ ×œ××¨×›×–
                dialogue: {
                    text: "×”×›×ª×‘×™× ×”×¢×ª×™×§×™×... ×”× ××¡×¤×¨×™× ×”×›×œ.",
                    options: [
                        { text: "××” ×”× ××¡×¤×¨×™× ×¢×œ ×”×©×¨×™×“?", response: "×©×”×•× ××¤×ª×— ×œ×›×•×— ××“×™×¨. ××¡×•×¨ ×©×”×•× ×™×™×¤×•×œ ×œ×™×“×™×™× ×”×œ× × ×›×•× ×•×ª.", quest: "quest4" },
                        { text: "××™×¤×” ×”×•×?", response: "×”×›×ª×•×‘×ª ××•××¨×ª: '×‘××§×•× ×©×‘×• ×”×“× × ×©×¤×š ×œ××™×'.", quest: null },
                        { text: "×ª×•×“×”", response: "×”×™×–×”×¨ ××”×¦×œ×œ×™×.", quest: "quest5" }
                    ]
                },
                info: "monk"
            }
        };

        // ××™×“×¢ ×”×™×¡×˜×•×¨×™
        const historicalInfo = {
            colosseum: {
                title: "×”×§×•×œ×•×¡×™××•× - ××‘×¦×¨ ×™××™ ×”×‘×™× ×™×™×",
                text: "×‘×™××™ ×”×‘×™× ×™×™×, ×”×§×•×œ×•×¡×™××•× ×”×¤×š ×œ××‘×¦×¨ ×‘×‘×¢×œ×•×ª ××©×¤×—×ª ×¤×¨× ×’'×™×¤× ×™. ×”××‘× ×™× × ×œ×§×—×• ×œ×‘× ×™×™×ª ××¨××•× ×•×ª ×•×›× ×¡×™×•×ª, ×•×”×–×™×¨×” ×”×¤×›×” ×œ×‘×™×ª ×§×‘×¨×•×ª."
            },
            arena: {
                title: "×”×–×™×¨×” ×”× ×˜×•×©×”",
                text: "×”×–×™×¨×”, ×©×¤×¢× ××™×¨×—×” ×§×¨×‘×•×ª ×’×œ×“×™××˜×•×¨×™×, ×›×•×¡×ª×” ×‘×¢×¤×¨ ×•×¦××—×™×™×”. ×”××‘×•×›×™× ×”×ª×ª-×§×¨×§×¢×™×™× × ×¡×ª××• ××• ×©×™××©×• ×œ××’×•×¨×™× ×•××—×¡× ×™×."
            },
            temple: {
                title: "×›× ×¡×™×•×ª ×•×‘×ª×™ ×›× ×¡×ª",
                text: "×¢× ×¢×œ×™×™×ª ×”× ×¦×¨×•×ª, ××§×“×©×™× ×¤×’×× ×™×™× ×¨×‘×™× ×”×•×¡×‘×• ×œ×›× ×¡×™×•×ª (×›××• ×”×¤× ×ª××•×Ÿ). ×”×§×”×™×œ×” ×”×™×”×•×“×™×ª ×‘×¨×•×× ×”××©×™×›×” ×œ×”×ª×§×™×™× ×‘×¨×•×‘×¢ ×”×™×”×•×“×™ (×”×’×˜×• ×œ×¢×ª×™×“) ×¢× ×‘×ª×™ ×›× ×¡×ª ×¢×ª×™×§×™×."
            },
            forum: {
                title: "×©×“×” ×”×¤×¨×•×ª (Campo Vaccino)",
                text: "×”×¤×•×¨×•× ×”×¨×•××™, ××¨×›×– ×”×¢×•×œ× ×”×¢×ª×™×§, ×”×•×–× ×— ×•×›×•×¡×” ×‘×©×›×‘×•×ª ×¢×¤×¨. ×”×•× ×§×™×‘×œ ××ª ×”×›×™× ×•×™ '×©×“×” ×”×¤×¨×•×ª' ×•×©×™××© ×œ××¨×¢×” ×•×œ×©×•×§ ×‘×§×¨."
            },
            house: {
                title: "×‘×™×ª ××™××™ ×”×‘×™× ×™×™×",
                text: "×”×‘×ª×™× ×”×¨×•××™×™× ×”××¤×•××¨×™× ×¤×™× ×• ××ª ××§×•×× ×œ××‘× ×™× ×¦×¤×•×¤×™× ×™×•×ª×¨, ×œ×¢×™×ª×™× ×‘× ×•×™×™× ×¢×œ ×—×•×¨×‘×•×ª ×”×¢×‘×¨. ××’×“×œ×™ ×©××™×¨×” ×¤×¨×˜×™×™× ×”×—×œ×• ×œ×¦×•×¥ ×‘×¨×—×‘×™ ×”×¢×™×¨."
            },
            fountain: {
                title: "×‘××¨ ××™×",
                text: "×¨×‘×™× ××”××§×•×•×“×•×§×˜×™× × ×”×¨×¡×•, ×•×”×ª×•×©×‘×™× × ××œ×¦×• ×œ×”×¡×ª××š ×¢×œ ×‘××¨×•×ª ××™× ××§×•××™×•×ª ×•×¢×œ × ×”×¨ ×”×˜×™×‘×¨, ×‘××§×•× ×¢×œ ×”××–×¨×§×•×ª ×”××¤×•××¨×•×ª ×©×œ ×”×¢×‘×¨."
            },
            statue: {
                title: "×©×¨×™×“×™ ×¤×¡×œ×™×",
                text: "×¤×¡×œ×™ ×”×©×™×© × ×©×¨×¤×• ×œ×¡×™×“, ×•×¤×¡×œ×™ ×”×‘×¨×•× ×–×” ×”×•×ª×›×• ×œ× ×©×§. ×¨×§ ××¢×˜×™× ×©×¨×“×•, ×œ×¢×™×ª×™× ×‘×–×›×•×ª ×¤×¨×©× ×•×ª × ×•×¦×¨×™×ª ×©× ×™×ª× ×” ×œ×“××•×™×•×ª (×›××• ×¤×¡×œ ××¨×§×•×¡ ××•×¨×œ×™×•×¡)."
            },
            garden: {
                title: "×‘×•×¡×ª×Ÿ ×× ×–×¨",
                text: "×”×’× ×™× ×”×¦×™×‘×•×¨×™×™× × ×¢×œ××•, ×•×‘××§×•×× ×”×•×¤×™×¢×• ×’× ×™× ×¡×’×•×¨×™× ×‘×ª×•×š ×× ×–×¨×™× ×•××¨××•× ×•×ª, ×©×©×™××©×• ×œ×’×™×“×•×œ ×¦××—×™ ××¨×¤× ×•××–×•×Ÿ."
            }
        };

        // Gamepad Support
        window.addEventListener("gamepadconnected", (e) => {
            console.log("Gamepad connected:", e.gamepad.id);
            gamepadIndex = e.gamepad.index;
            gamepadConnected = true;
            document.getElementById('gamepad-indicator').style.display = 'block';
            setTimeout(() => {
                document.getElementById('gamepad-indicator').style.display = 'none';
            }, 3000);
        });

        window.addEventListener("gamepaddisconnected", (e) => {
            console.log("Gamepad disconnected");
            if (e.gamepad.index === gamepadIndex) {
                gamepadIndex = null;
                gamepadConnected = false;
            }
        });

        function handleGamepadInput() {
            if (!gamepadConnected || gamepadIndex === null) return;
            
            const gamepads = navigator.getGamepads();
            const gp = gamepads[gamepadIndex];
            if (!gp) return;
            
            // Left stick - movement
            const leftX = gp.axes[0];
            const leftY = gp.axes[1];
            const deadzone = 0.15;
            
            if (!viewMode) {
                moveLeft = leftX < -deadzone;
                moveRight = leftX > deadzone;
                moveForward = leftY < -deadzone;
                moveBackward = leftY > deadzone;
            }
            
            const rightX = gp.axes[2];
            const rightY = gp.axes[3];
            const cameraSensitivity = 0.04;
            
            if (controls && controls.isLocked) {
                if (Math.abs(rightX) > deadzone) {
                    cameraRotationY -= rightX * cameraSens
